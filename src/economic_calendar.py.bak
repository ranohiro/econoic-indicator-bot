#!/usr/bin/env python3
"""
çµŒæ¸ˆæŒ‡æ¨™Discordè‡ªå‹•é€šçŸ¥ãƒ„ãƒ¼ãƒ«

Finnhub Economic Calendar APIã‹ã‚‰ç¿Œé€±ã®é‡è¦çµŒæ¸ˆæŒ‡æ¨™ã‚’å–å¾—ã—ã€
Discord Webhookã§é€šçŸ¥ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
"""

import os
import sys
from datetime import datetime, timedelta
from typing import List, Dict, Optional
import requests
import pytz
from dotenv import load_dotenv

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
load_dotenv()


# å®šæ•°å®šç¾©
FINNHUB_API_BASE = "https://finnhub.io/api/v1"
DISCORD_CHAR_LIMIT = 2000
COUNTRY_FLAGS = {
    "US": "ğŸ‡ºğŸ‡¸",
    "JP": "ğŸ‡¯ğŸ‡µ",
    "EU": "ğŸ‡ªğŸ‡º",
    "GB": "ğŸ‡¬ğŸ‡§",
    "CN": "ğŸ‡¨ğŸ‡³",
    "DE": "ğŸ‡©ğŸ‡ª",
    "FR": "ğŸ‡«ğŸ‡·",
    "IT": "ğŸ‡®ğŸ‡¹",
    "CA": "ğŸ‡¨ğŸ‡¦",
    "AU": "ğŸ‡¦ğŸ‡º",
}


def get_next_week_dates() -> tuple[str, str]:
    """
    ç¿Œé€±ã®æ—¥æ›œæ—¥ã‹ã‚‰åœŸæ›œæ—¥ã¾ã§ã®æ—¥ä»˜ç¯„å›²ã‚’å–å¾—
    
    Returns:
        (start_date, end_date): YYYY-MM-DDå½¢å¼ã®æ—¥ä»˜ã‚¿ãƒ—ãƒ«
    """
    # æ—¥æœ¬æ™‚é–“ã§ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š
    jst = pytz.timezone('Asia/Tokyo')
    now = datetime.now(jst)
    
    # ç¾åœ¨ã®æ›œæ—¥ã‚’å–å¾— (0=æœˆæ›œæ—¥, 6=æ—¥æ›œæ—¥)
    current_weekday = now.weekday()
    
    # æ¬¡ã®æ—¥æ›œæ—¥ã¾ã§ã®æ—¥æ•°ã‚’è¨ˆç®— (æ—¥æ›œæ—¥ = 6)
    days_until_sunday = (6 - current_weekday) % 7
    if days_until_sunday == 0:
        days_until_sunday = 7  # ä»Šæ—¥ãŒæ—¥æ›œæ—¥ã®å ´åˆã€æ¥é€±ã®æ—¥æ›œæ—¥
    
    # ç¿Œé€±ã®æ—¥æ›œæ—¥
    next_sunday = now + timedelta(days=days_until_sunday)
    # ç¿Œé€±ã®åœŸæ›œæ—¥
    next_saturday = next_sunday + timedelta(days=6)
    
    start_date = next_sunday.strftime("%Y-%m-%d")
    end_date = next_saturday.strftime("%Y-%m-%d")
    
    return start_date, end_date


def fetch_economic_calendar(api_key: str, start_date: str, end_date: str) -> List[Dict]:
    """
    Finnhub APIã‹ã‚‰çµŒæ¸ˆæŒ‡æ¨™ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å–å¾—
    
    Args:
        api_key: Finnhub APIã‚­ãƒ¼
        start_date: é–‹å§‹æ—¥ (YYYY-MM-DD)
        end_date: çµ‚äº†æ—¥ (YYYY-MM-DD)
    
    Returns:
        çµŒæ¸ˆæŒ‡æ¨™ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ
    
    Raises:
        requests.RequestException: APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ãŸå ´åˆ
    """
    url = f"{FINNHUB_API_BASE}/calendar/economic"
    params = {
        "from": start_date,
        "to": end_date,
        "token": api_key
    }
    
    print(f"ğŸ“¡ Finnhub APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­... (æœŸé–“: {start_date} ~ {end_date})")
    
    response = requests.get(url, params=params, timeout=30)
    response.raise_for_status()
    
    data = response.json()
    
    # econmicCalendarãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    if "economicCalendar" in data:
        events = data["economicCalendar"]
        print(f"âœ… {len(events)}ä»¶ã®çµŒæ¸ˆæŒ‡æ¨™ã‚’å–å¾—ã—ã¾ã—ãŸ")
        return events
    else:
        print("âš ï¸ çµŒæ¸ˆæŒ‡æ¨™ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
        return []


def filter_high_impact_events(events: List[Dict]) -> List[Dict]:
    """
    é‡è¦åº¦ãŒé«˜ã„ (impact == "high") æŒ‡æ¨™ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    
    Args:
        events: çµŒæ¸ˆæŒ‡æ¨™ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ
    
    Returns:
        ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸçµŒæ¸ˆæŒ‡æ¨™ã®ãƒªã‚¹ãƒˆ
    """
    filtered = [event for event in events if event.get("impact") == "high"]
    print(f"ğŸ” é«˜ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆæŒ‡æ¨™: {len(filtered)}ä»¶")
    return filtered


def format_value(value: Optional[float]) -> str:
    """
    æ•°å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆæœªå®šã®å ´åˆã¯ "-" ã‚’è¿”ã™ï¼‰
    
    Args:
        value: æ•°å€¤ã¾ãŸã¯None
    
    Returns:
        ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸæ–‡å­—åˆ—
    """
    if value is None or value == "":
        return "-"
    return str(value)


def convert_utc_to_jst(utc_timestamp: str) -> str:
    """
    UTCæ™‚åˆ»ã‚’æ—¥æœ¬æ™‚é–“ (JST) ã«å¤‰æ›
    
    Args:
        utc_timestamp: UTCæ™‚åˆ»æ–‡å­—åˆ— (ISO 8601å½¢å¼)
    
    Returns:
        æ—¥æœ¬æ™‚é–“ã®æ–‡å­—åˆ— (YYYY/MM/DD HH:mm)
    """
    try:
        # UTCæ™‚åˆ»ã‚’ãƒ‘ãƒ¼ã‚¹
        utc_time = datetime.fromisoformat(utc_timestamp.replace('Z', '+00:00'))
        
        # JSTã«å¤‰æ›
        jst = pytz.timezone('Asia/Tokyo')
        jst_time = utc_time.astimezone(jst)
        
        return jst_time.strftime("%Y/%m/%d %H:%M")
    except Exception as e:
        print(f"âš ï¸ æ™‚åˆ»å¤‰æ›ã‚¨ãƒ©ãƒ¼: {utc_timestamp} - {e}")
        return utc_timestamp


def create_discord_message(events: List[Dict], start_date: str, end_date: str) -> List[str]:
    """
    Discordç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆï¼ˆ2000æ–‡å­—åˆ¶é™ã‚’è€ƒæ…®ã—ã¦åˆ†å‰²ï¼‰
    
    Args:
        events: çµŒæ¸ˆæŒ‡æ¨™ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ
        start_date: é–‹å§‹æ—¥
        end_date: çµ‚äº†æ—¥
    
    Returns:
        ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ–‡å­—åˆ—ã®ãƒªã‚¹ãƒˆ
    """
    if not events:
        return [f"ğŸ“Š **ç¿Œé€±ã®é‡è¦çµŒæ¸ˆæŒ‡æ¨™** ({start_date} ~ {end_date})\n\nä»Šé€±ã¯é‡è¦çµŒæ¸ˆæŒ‡æ¨™ã®äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚"]
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    header = f"ğŸ“Š **ç¿Œé€±ã®é‡è¦çµŒæ¸ˆæŒ‡æ¨™** ({start_date} ~ {end_date})\n\n"
    
    messages = []
    current_message = header
    
    # ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«ã‚½ãƒ¼ãƒˆ
    sorted_events = sorted(events, key=lambda x: x.get("time", ""))
    
    for event in sorted_events:
        country = event.get("country", "XX")
        flag = COUNTRY_FLAGS.get(country, "ğŸ³ï¸")
        event_name = event.get("event", "ä¸æ˜ãªæŒ‡æ¨™")
        time_utc = event.get("time", "")
        time_jst = convert_utc_to_jst(time_utc) if time_utc else "æœªå®š"
        
        previous = format_value(event.get("previous"))
        estimate = format_value(event.get("estimate"))
        
        # ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        event_text = (
            f"**{flag} {country} - {time_jst}**\n"
            f"æŒ‡æ¨™: {event_name}\n"
            f"å‰å›: {previous} | äºˆæƒ³: {estimate}\n\n"
        )
        
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ2000æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯åˆ†å‰²
        if len(current_message) + len(event_text) > DISCORD_CHAR_LIMIT:
            messages.append(current_message.strip())
            current_message = event_text
        else:
            current_message += event_text
    
    # æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    if current_message.strip():
        messages.append(current_message.strip())
    
    return messages


def send_to_discord(webhook_url: str, messages: List[str]) -> None:
    """
    Discord Webhookã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    
    Args:
        webhook_url: Discord Webhook URL
        messages: é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆ
    
    Raises:
        requests.RequestException: Webhookå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ãŸå ´åˆ
    """
    for i, message in enumerate(messages, 1):
        print(f"ğŸ“¤ Discordã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­... ({i}/{len(messages)})")
        
        payload = {"content": message}
        response = requests.post(webhook_url, json=payload, timeout=10)
        response.raise_for_status()
        
        print(f"âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ {i}/{len(messages)} é€ä¿¡å®Œäº†")


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    print("=" * 60)
    print("çµŒæ¸ˆæŒ‡æ¨™Discordè‡ªå‹•é€šçŸ¥ãƒ„ãƒ¼ãƒ«")
    print("=" * 60)
    
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
    api_key = os.getenv("FINNHUB_API_KEY")
    webhook_url = os.getenv("DISCORD_WEBHOOK_URL")
    
    if not api_key:
        print("âŒ ã‚¨ãƒ©ãƒ¼: FINNHUB_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        sys.exit(1)
    
    if not webhook_url:
        print("âŒ ã‚¨ãƒ©ãƒ¼: DISCORD_WEBHOOK_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        sys.exit(1)
    
    try:
        # ç¿Œé€±ã®æ—¥ä»˜ç¯„å›²ã‚’å–å¾—
        start_date, end_date = get_next_week_dates()
        print(f"ğŸ“… å¯¾è±¡æœŸé–“: {start_date} ~ {end_date}")
        
        # Finnhub APIã‹ã‚‰çµŒæ¸ˆæŒ‡æ¨™ã‚’å–å¾—
        events = fetch_economic_calendar(api_key, start_date, end_date)
        
        # é«˜ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆæŒ‡æ¨™ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        high_impact_events = filter_high_impact_events(events)
        
        # Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
        messages = create_discord_message(high_impact_events, start_date, end_date)
        
        # Discordã«é€ä¿¡
        send_to_discord(webhook_url, messages)
        
        print("=" * 60)
        print("âœ… å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ")
        print("=" * 60)
        
    except requests.RequestException as e:
        error_message = f"âŒ APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: {str(e)}"
        print(error_message)
        
        # ã‚¨ãƒ©ãƒ¼ã‚‚Discordã«é€šçŸ¥
        try:
            send_to_discord(webhook_url, [error_message])
        except:
            pass
        
        sys.exit(1)
    
    except Exception as e:
        error_message = f"âŒ äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼: {str(e)}"
        print(error_message)
        
        # ã‚¨ãƒ©ãƒ¼ã‚‚Discordã«é€šçŸ¥
        try:
            send_to_discord(webhook_url, [error_message])
        except:
            pass
        
        sys.exit(1)


if __name__ == "__main__":
    main()
